<!doctype html>
<html lang="et">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Jutumasin</title>
  <style>
    :root{
      --bg1:#07000a; --bg2:#120014;
      --pink:#ff4da6; --pink2:#ff1f8f;
      --text:#ffe9f5; --muted:#d9a9c6;
      --card:#12000f; --card2:#1b0018;
      --r:22px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; height:100vh;
      display:flex; align-items:center; justify-content:center;
      padding:0;
      font-family:"Segoe UI Variable Display","Segoe UI Variable","Segoe UI",system-ui,-apple-system,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 15% 10%, rgba(255,77,166,.22), transparent 58%),
        radial-gradient(1100px 700px at 85% 20%, rgba(255,31,143,.18), transparent 62%),
        linear-gradient(180deg, var(--bg2), var(--bg1));
      overflow:hidden;
    }

    .bgHearts{
      position:fixed; inset:-45%;
      pointer-events:none;
      opacity:.11;
      filter: blur(.7px);
      background-repeat: repeat;
      background-image:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='980' height='980' viewBox='0 0 980 980'%3E%3Cg fill='%23ff4da6' fill-opacity='0.18'%3E%3Ctext x='110' y='560' font-size='320'%3E%E2%99%A5%3C/text%3E%3Ctext x='620' y='430' font-size='230'%3E%E2%99%A5%3C/text%3E%3Ctext x='470' y='910' font-size='270'%3E%E2%99%A5%3C/text%3E%3C/g%3E%3C/svg%3E");
      background-size: 980px 980px;
      will-change: background-position;
      animation: heartsUp 220s linear infinite;
    }
    .bgHearts2{
      position:fixed; inset:-55%;
      pointer-events:none;
      opacity:.07;
      filter: blur(1.05px);
      background-repeat: repeat;
      background-image:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='1380' height='1380' viewBox='0 0 1380 1380'%3E%3Cg fill='%23ff1f8f' fill-opacity='0.12'%3E%3Ctext x='140' y='790' font-size='520'%3E%E2%99%A5%3C/text%3E%3Ctext x='900' y='640' font-size='340'%3E%E2%99%A5%3C/text%3E%3Ctext x='680' y='1330' font-size='410'%3E%E2%99%A5%3C/text%3E%3C/g%3E%3C/svg%3E");
      background-size: 1380px 1380px;
      will-change: background-position;
      animation: heartsUp 330s linear infinite;
    }
    @keyframes heartsUp{ from{ background-position: 0 0; } to{ background-position: 0 -2600px; } }

    .app{
      width:min(520px, 100%);
      height:100%;
      max-height:100vh;
      display:flex; flex-direction:column;
      background: linear-gradient(180deg, rgba(255,77,166,.12), rgba(0,0,0,.25));
      position:relative;
    }
    header{
      padding:14px 16px 10px;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      gap:8px;
      border-bottom:1px solid rgba(255,77,166,.22);
      background: linear-gradient(90deg, rgba(255,77,166,.18), rgba(0,0,0,.18));
      min-height:86px;
      text-align:center;
    }

    .brandBtn{
      appearance:none;background:transparent;border:none;padding:0;cursor:pointer;
      user-select:none;-webkit-user-select:none;color:inherit;
    }
    .brand{
      font-weight:950; letter-spacing:.7px; text-transform:uppercase;
      background: linear-gradient(90deg, rgba(255,77,166,1), rgba(255,233,245,.95), rgba(255,31,143,1));
      background-size: 200% 100%;
      -webkit-background-clip:text; background-clip:text; color:transparent;
      text-shadow: 0 10px 40px rgba(255,77,166,.12);
      font-size:22px;
      transition: font-size 140ms ease, transform 140ms ease, filter 140ms ease;
      user-select:none;-webkit-user-select:none;
      line-height:1;
    }
    body[data-view="menu"] .brand{ font-size:44px; transform: translateY(1px); }

    @keyframes logoShift { 0%{background-position:0% 50%} 100%{background-position:100% 50%} }
    body[data-view="menu"] .brandBtn:hover .brand{
      animation: logoShift 1.8s ease-in-out infinite alternate;
      text-shadow: 0 0 18px rgba(255,77,166,.45);
    }

    .tagline{
      max-width: 460px;
      color: rgba(255,233,245,.86);
      font-weight:800;
      font-size:12.5px;
      line-height:1.25;
      user-select:none;-webkit-user-select:none;
    }

    main{flex:1; display:flex; flex-direction:column; min-height:0}
    .screen{flex:1; display:none; padding:16px; min-height:0}
    .screen.active{display:flex; flex-direction:column; gap:14px}

    .grid{display:grid; gap:12px; grid-template-columns:1fr 1fr}
    .choice{
      padding:16px; border-radius:var(--r);
      background: linear-gradient(180deg, rgba(255,77,166,.10), rgba(0,0,0,.26));
      border:1px solid rgba(255,77,166,.22);
      cursor:pointer; min-height:96px;
      display:flex; flex-direction:column; justify-content:center;
      user-select:none;-webkit-user-select:none;
      transition: border-color 120ms ease, background 120ms ease, transform 120ms ease;
    }
    .choice:hover{ border-color: rgba(255,255,255,.28); }
    .choice:active{ background: linear-gradient(180deg, rgba(255,77,166,.06), rgba(0,0,0,.36)); transform: translateY(1px); }
    .choice h3{margin:0 0 8px 0; font-size:15px; font-weight:900}
    .choice p{margin:0; color:var(--muted); font-size:12px; line-height:1.25}

    .menuWrap{flex:1; display:flex; flex-direction:column; gap:12px; min-height:0}
    .aboutRow{margin-top:auto; display:flex; align-items:center; justify-content:center; gap:10px;}
    .aboutBtn{
      width:auto;
      border-radius:999px;
      padding:12px 16px;
      text-align:center;
      font-weight:900;
      background: linear-gradient(180deg, rgba(255,77,166,.14), rgba(0,0,0,.26));
      border:1px solid rgba(255,77,166,.26);
      cursor:pointer;
      user-select:none;-webkit-user-select:none;
      transition: border-color 120ms ease, background 120ms ease, transform 120ms ease;
    }
    .aboutBtn:hover{ border-color: rgba(255,255,255,.28); }
    .aboutBtn:active{ background: linear-gradient(180deg, rgba(255,77,166,.08), rgba(0,0,0,.36)); transform: translateY(1px); }
    .version{
      font-size:11px;
      color:var(--muted);
      user-select:none;-webkit-user-select:none;
    }

    .row{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .stat{
      padding:10px 12px; border-radius:16px;
      border:1px solid rgba(255,77,166,.22);
      background: rgba(0,0,0,.22);
      font-size:12px; color:var(--muted);
      white-space:nowrap;
      user-select:none;-webkit-user-select:none;
    }

    .cardArea{flex:1; display:flex; align-items:center; justify-content:center; position:relative; padding:0; min-height:0}
    .deck{width:100%; height:100%; display:flex; align-items:center; justify-content:center; position:relative; min-height:0}
    .swipeCard{
      width:100%; max-width:520px; height:100%;
      border-radius:var(--r);
      background: linear-gradient(180deg, var(--card2), var(--card));
      border:1px solid rgba(255,77,166,.30);
      box-shadow: 0 18px 70px rgba(0,0,0,.65);
      position:absolute;
      touch-action:none;
      user-select:none;-webkit-user-select:none;
      overflow:hidden;
      transform: translate(0,0) rotate(0deg);
      transition: transform 160ms ease, opacity 160ms ease;
    }
    .inner{
      height:100%;
      padding:26px 24px;
      display:flex; flex-direction:column;
      justify-content:center; align-items:center;
      text-align:center; gap:18px;
      background:
        radial-gradient(1100px 700px at 20% 0%, rgba(255,77,166,.22), transparent 62%),
        radial-gradient(1100px 700px at 85% 20%, rgba(255,31,143,.18), transparent 62%);
    }
    .title{font-size:54px; font-weight:950; line-height:1.0}
    .desc{font-size:28px; font-weight:900; color:rgba(255,233,245,.95); line-height:1.2}
    .foot{
      position:absolute; left:24px; right:24px; bottom:18px;
      font-size:14px; font-weight:800; color:var(--muted);
      border-top:1px solid rgba(255,77,166,.22);
      padding-top:14px; text-align:left;
      user-select:none;-webkit-user-select:none;
    }

    .starBtn{
      position:absolute; right:14px; bottom:70px;
      width:46px; height:46px; border-radius:999px;
      display:flex; align-items:center; justify-content:center;
      border:1px solid rgba(255,209,234,.40);
      background: rgba(0,0,0,.28);
      box-shadow: 0 12px 30px rgba(0,0,0,.45);
      font-size:20px; line-height:1; padding:0;
      cursor:pointer; color:#ffd1ea; z-index:5;
      user-select:none;-webkit-user-select:none;
    }
    .starBtn span{display:block; transform: translateY(-1px);}
    .starBtn:active{transform: translateY(1px)}

    .controls{
      padding:14px 16px;
      display:none;
      gap:12px; justify-content:center;
      border-top:1px solid rgba(255,77,166,.22);
      background: rgba(0,0,0,.22);
    }
    button.ctrl{
      appearance:none; cursor:pointer;
      border-radius:999px; padding:12px 16px;
      color:var(--text); font-weight:900;
      background: linear-gradient(180deg, rgba(255,77,166,.18), rgba(0,0,0,.25));
      border:1px solid rgba(255,77,166,.26);
      min-width:110px;
      transition: background 120ms ease, border-color 120ms ease, transform 120ms ease;
      user-select:none;-webkit-user-select:none;
    }
    button.ctrl:hover{ border-color: rgba(255,255,255,.28); }
    button.ctrl:active{
      background: linear-gradient(180deg, rgba(255,77,166,.10), rgba(0,0,0,.38));
      transform: translateY(1px);
    }
    button.ctrl[disabled]{opacity:.45; cursor:default}

    .aboutCard{
      border-radius:var(--r);
      background: linear-gradient(180deg, rgba(255,77,166,.10), rgba(0,0,0,.28));
      border:1px solid rgba(255,77,166,.22);
      padding:18px;
      min-height:140px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      font-weight:900;
      font-size:16px;
      user-select:none;-webkit-user-select:none;
    }
    .aboutCard a{
      color: rgba(255,233,245,.95);
      text-decoration: none;
      font-weight:900;
      border-bottom:1px solid rgba(255,255,255,.25);
      padding-bottom:2px;
    }
    .aboutCard a:hover{ border-bottom-color: rgba(255,255,255,.55); }
  </style>
</head>
<body data-view="menu">
  <div class="bgHearts"></div>
  <div class="bgHearts2"></div>

  <div class="app">
    <header>
      <button class="brandBtn" id="brandHome" type="button" aria-label="Avaleht">
        <div class="brand">Jutumasin</div>
      </button>
      <div class="tagline">Lihtne küsimuste kaardimäng kahele või rohkemale. Vali rubriik ja swipei kaarte kas edasi või tagasi.</div>
    </header>

    <main>
      <section id="menuScreen" class="screen active">
        <div class="menuWrap">
          <div class="grid" id="menuGrid"></div>
          <div class="aboutRow">
            <div class="aboutBtn" id="aboutBtn">About</div>
            <div class="version">v1.0</div>
          </div>
        </div>
      </section>

      <section id="aboutScreen" class="screen">
        <div class="aboutCard">
          <div>
            Basic ass shit chatgpt veebileht loodud by Renno :D
            <br><br>
            <a href="https://github.com/jutumasin/jutumasin" target="_blank" rel="noopener">https://github.com/jutumasin/jutumasin</a>
          </div>
        </div>
      </section>

      <section id="gameScreen" class="screen">
        <div class="row">
          <div class="stat" id="deckName">Tüüp: —</div>
          <div class="stat" id="progress">0</div>
        </div>
        <div class="cardArea"><div class="deck" id="deck"></div></div>
      </section>

      <section id="historyScreen" class="screen">
        <div class="row">
          <div class="stat" id="historyName">Ajalugu: —</div>
          <div class="stat" id="historyPos">0</div>
        </div>
        <div class="cardArea"><div class="deck" id="historyDeck"></div></div>
      </section>

      <section id="bestScreen" class="screen">
        <div class="row">
          <div class="stat" id="bestName">Parimad: —</div>
          <div class="stat" id="bestPos">0</div>
        </div>
        <div class="cardArea"><div class="deck" id="bestDeck"></div></div>
      </section>
    </main>

    <div class="controls" id="controls">
      <button class="ctrl" id="btnBack">⬅️ Tagasi</button>
      <button class="ctrl" id="btnMenu">☰ Menüü</button>
      <button class="ctrl" id="btnNext">Edasi ➡️</button>
    </div>
  </div>

  <script>
const DECKS = {
  "Dating": [
    {title:"Küsimus",desc:"Mis on su lemmik datei mälestus?",foot:"• kohtingu küsimused"},
    {title:"Küsimus",desc:"Mis tegevus teeb sind suhtes kõige õnnelikumaks?",foot:"• kohtingu küsimused"},
    {title:"Küsimus",desc:"Mis on su armastuskeel?",foot:"• kohtingu küsimused"},
    {title:"Küsimus",desc:"Mida sa minus esimesena märkasid?",foot:"• kohtingu küsimused"},
    {title:"Küsimus",desc:"Kus on ideaalne kohtinguõhtu sinu jaoks?",foot:"• kohtingu küsimused"},
    {title:"Küsimus",desc:"Mis harjumus mul on, mis sulle meeldib?",foot:"• kohtingu küsimused"},
    {title:"Küsimus",desc:"Mis paneb sind end turvaliselt tundma suhtes?",foot:"• kohtingu küsimused"},
    {title:"Küsimus",desc:"Mis on su unistuste reis kahekesi?",foot:"• kohtingu küsimused"},
    {title:"Küsimus",desc:"Kas eelistad musi ja kallistusi või suulisi ja kirjalikke armastus avaldusi?",foot:"• kohtingu küsimused"},
    {title:"Küsimus",desc:"Mis on su lemmik date koostegevus?",foot:"• kohtingu küsimused"},
    {title:"Küsimus",desc:"Millal sa tundsid, et klapp on olemas?",foot:"• kohtingu küsimused"},
    {title:"Küsimus",desc:"Mis kompliment sulle kõige rohkem meeldib?",foot:"• kohtingu küsimused"},
    {title:"Küsimus",desc:"Kas oled rohkem hommiku- või õhtuinimene?",foot:"• kohtingu küsimused"},
    {title:"Küsimus",desc:"Kas eelistad kallist või väga odavat kohtingut",foot:"• kohtingu küsimused"},
    {title:"Küsimus",desc:"Mida sa ootad healt suhtelt?",foot:"• kohtingu küsimused"},
    {title:"Küsimus",desc:"Kas eelistad spontaansust või planeerimist?",foot:"• kohtingu küsimused"},
    {title:"Küsimus",desc:"Mis on su lemmik viis kiindumust näidata?",foot:"• kohtingu küsimused"},
    {title:"Küsimus",desc:"Kas sa usud hingesugulastesse?",foot:"• kohtingu küsimused"},
    {title:"Küsimus",desc:"Kas eelistad kodust või aktiivset kohtingut?",foot:"• kohtingu küsimused"},
    {title:"Küsimus",desc:"Mis väike žest sind rõõmustab?",foot:"• kohtingu küsimused"},
    {title:"Küsimus",desc:"Kas oled armukade tüüp?",foot:"• kohtingu küsimused"},
    {title:"Küsimus",desc:"Mis on parim kompliment, mida oled saanud?",foot:"• kohtingu küsimused"},
    {title:"Küsimus",desc:"Kas eelistad sügavaid vestlusi või nalja?",foot:"• kohtingu küsimused"},
    {title:"Küsimus",desc:"Mis on su ideaalne nädalavahetus kahekesi?",foot:"• kohtingu küsimused"},
    {title:"Küsimus",desc:"Kas naudid rohkem üllatusi või rutiini?",foot:"• kohtingu küsimused"},
    {title:"Küsimus",desc:"Mis on su lemmik ühine mälestus?",foot:"• kohtingu küsimused"},
    {title:"Küsimus",desc:"Kas eelistad avalikku või privaatset kiindumust?",foot:"• kohtingu küsimused"},
    {title:"Küsimus",desc:"Mis on su lemmik viis vabandada?",foot:"• kohtingu küsimused"},
    {title:"Küsimus",desc:"Mida tahaksid koos kogeda?",foot:"• kohtingu küsimused"}
  ],
  "Spicy": [
    {title:"Küsimus",desc:"Mis on su lemmik viis flirtida?",foot:"• spicy"},
    {title:"Küsimus",desc:"Mis on su salajane turn-on?",foot:"• spicy"},
    {title:"Küsimus",desc:"Mis kompliment sind punastama paneb?",foot:"• spicy"},
    {title:"Küsimus",desc:"Kus sulle meeldib, kui sind puudutatakse?",foot:"• spicy"},
    {title:"Küsimus",desc:"Kas naudid rohkem algatamist või meeldib kui teine algatab?",foot:"• spicy"},
    {title:"Küsimus",desc:"Kas sulle meeldib sosistamine kõrva?",foot:"• spicy"},
    {title:"Küsimus",desc:"Mis on su lemmik romantiline voodis?",foot:"• spicy"},
    {title:"Küsimus",desc:"Kas eelistad tulesid sees või hämarust?",foot:"• spicy"},
    {title:"Küsimus",desc:"Mis riietus on sinu meelest eriti atraktiivne?",foot:"• spicy"},
    {title:"Küsimus",desc:"Kas sulle meeldib kiuslik flirt?",foot:"• spicy"},
    {title:"Küsimus",desc:"Mis paneb sind partneri juures sulama?",foot:"• spicy"},
    {title:"Küsimus",desc:"Kas sulle meeldib, kui partner juhib?",foot:"• spicy"},
    {title:"Küsimus",desc:"Kas sõnumites flirtimine meeldib?",foot:"• spicy"},
    {title:"Küsimus",desc:"Mis teeb su enesekindlaks?",foot:"• spicy"},
    {title:"Küsimus",desc:"Kas sulle meeldib rollimäng?",foot:"• spicy"},
    {title:"Küsimus",desc:"Kas eelistad vaikust või muusikat?",foot:"• spicy"},
    {title:"Küsimus",desc:"Mis on su lemmik koht kahekesi olla?",foot:"• spicy"},
    {title:"Küsimus",desc:"Kas naudid pikalt silmsidet?",foot:"• spicy"},
    {title:"Küsimus",desc:"Mis on su lemmik eelmäng?",foot:"• spicy"},
    {title:"Küsimus",desc:"Kas naudid aeglast lähenemist või tahaksid vahele jätta?",foot:"• spicy"}
  ],
  "Couples": [
    {title:"Küsimus",desc:"Mis on meie suhte tugevus?",foot:"• paaridele"},
    {title:"Küsimus",desc:"Mis harjumus meid ühendab?",foot:"• paaridele"},
    {title:"Küsimus",desc:"Kuidas lahendame tülisid?",foot:"• paaridele"},
    {title:"Küsimus",desc:"Mis teeb meid heaks tiimiks?",foot:"• paaridele"},
    {title:"Küsimus",desc:"Kuidas sa tahad et sulle näidatakse hoolivust?",foot:"• paaridele"},
    {title:"Küsimus",desc:"Mis on meie ühine unistus?",foot:"• paaridele"},
    {title:"Küsimus",desc:"Kuidas veedame kvaliteetaega?",foot:"• paaridele"},
    {title:"Küsimus",desc:"Kuidas jagame kohustusi?",foot:"• paaridele"},
    {title:"Küsimus",desc:"Mis meid rahustab?",foot:"• paaridele"},
    {title:"Küsimus",desc:"Mis on meie ühine hobi?",foot:"• paaridele"},
    {title:"Küsimus",desc:"Mis on meie väärtused?",foot:"• paaridele"}
  ],
  "Party": [
    {title:"Tõsta käsi",desc:"kui oled 4 päeva järjest joonud.",foot:"• peomäng"},
    {title:"Küsimus",desc:"Kes on täna kõige kõige rohkem alkoholi tarbinud",foot:"• peomäng"},
    {title:"Küsimus",desc:"Kes on teinud spontaanse reisi?",foot:"• peomäng"},
    {title:"Tõsta käsi",desc:"Kes on saatnud eksile sõnumi öösel?",foot:"• peomäng"},
    {title:"Tõsta käsi",desc:"Kes on hiljaks jäänud kohtingule?",foot:"• peomäng"},
    {title:"Tõsta käsi",desc:"Kes on kunagi valetanud enda kohta?",foot:"• peomäng"},
    {title:"Tõsta käsi",desc:"Kes on kaotanud telefoni peol?",foot:"• peomäng"},
    {title:"Küsimus",desc:"Mis on kõige kallim impulss ost olnud?",foot:"• peomäng"},
    {title:"Küsimus",desc:"Kes on olnud peo hing?",foot:"• peomäng"},
    {title:"Küsimus",desc:"Kes on leidnud uue sõbra?",foot:"• peomäng"},
    {title:"Küsimus",desc:"Kes on teinud peo meeldejäävaks?",foot:"• peomäng"}
  ]
};
    const State = {
      deckKey: null,
      cards: [],
      index: 0,
      histories: {},
      bests: {},
      viewDeckKey: null,
      viewMode: "menu",
      viewPos: 0
    };

    const el = {
      menu: document.getElementById("menuScreen"),
      about: document.getElementById("aboutScreen"),
      game: document.getElementById("gameScreen"),
      history: document.getElementById("historyScreen"),
      best: document.getElementById("bestScreen"),
      menuGrid: document.getElementById("menuGrid"),
      aboutBtn: document.getElementById("aboutBtn"),
      deck: document.getElementById("deck"),
      historyDeck: document.getElementById("historyDeck"),
      bestDeck: document.getElementById("bestDeck"),
      deckName: document.getElementById("deckName"),
      progress: document.getElementById("progress"),
      historyName: document.getElementById("historyName"),
      historyPos: document.getElementById("historyPos"),
      bestName: document.getElementById("bestName"),
      bestPos: document.getElementById("bestPos"),
      controls: document.getElementById("controls"),
      btnBack: document.getElementById("btnBack"),
      btnMenu: document.getElementById("btnMenu"),
      btnNext: document.getElementById("btnNext"),
      brandHome: document.getElementById("brandHome")
    };

    function showScreen(name){
      el.menu.classList.toggle("active", name === "menu");
      el.about.classList.toggle("active", name === "about");
      el.game.classList.toggle("active", name === "game");
      el.history.classList.toggle("active", name === "history");
      el.best.classList.toggle("active", name === "best");
      State.viewMode = name;
      document.body.setAttribute("data-view", name);
      el.controls.style.display = (name === "menu") ? "none" : "flex";
      updateButtons();
    }

    function totalCount(map){
      let n=0; Object.keys(map).forEach(k => n += (map[k]?.length || 0)); return n;
    }

    function buildMenu(){
      const hTotal = totalCount(State.histories);
      const bTotal = totalCount(State.bests);
      const items = [
        { title:"Dating",  sub:"kohtingu küsimused", action:()=>startGame("Dating") },
        { title:"Spicy",   sub:"põnevamad küsimused", action:()=>startGame("Spicy") },
        { title:"Couples", sub:"paaridele küsimused", action:()=>startGame("Couples") },
        { title:"Party",   sub:"peomänguks", action:()=>startGame("Party") },
        { title:"Ajalugu", sub:`mis sa enne swipinud oled (${hTotal})`, action:()=>openList("history") },
        { title:"Parimad", sub:`välja valitud parimad (${bTotal})`, action:()=>openList("best") }
      ];
      el.menuGrid.innerHTML = "";
      items.forEach(it=>{
        const c=document.createElement("div");
        c.className="choice";
        c.innerHTML = `<h3>${it.title}</h3><p>${it.sub}</p>`;
        c.addEventListener("click", it.action);
        el.menuGrid.appendChild(c);
      });
    }

    function updateButtons(){
      if(State.viewMode === "history"){
        const list = State.histories[State.viewDeckKey] || [];
        el.btnBack.disabled = !(list.length && State.viewPos > 0);
        el.btnNext.disabled = !(list.length && State.viewPos < list.length - 1);
      } else if(State.viewMode === "best"){
        const list = State.bests[State.viewDeckKey] || [];
        el.btnBack.disabled = !(list.length && State.viewPos > 0);
        el.btnNext.disabled = !(list.length && State.viewPos < list.length - 1);
      } else if(State.viewMode === "game"){
        el.btnBack.disabled = (State.index <= 0);
        el.btnNext.disabled = (State.index >= State.cards.length - 1);
      } else {
        el.btnBack.disabled = false;
        el.btnNext.disabled = false;
      }
    }

    function startGame(deckKey){
      State.deckKey = deckKey;
      State.cards = shuffle([...DECKS[deckKey]]);
      State.index = 0;
      if(!State.histories[deckKey]) State.histories[deckKey] = [];
      if(!State.bests[deckKey]) State.bests[deckKey] = [];
      el.deckName.textContent = `Tüüp: ${deckKey}`;
      showScreen("game");
      renderStack();
      updateProgress();
      buildMenu();
    }

    function openList(mode){
      const dk = State.deckKey || Object.keys(DECKS)[0];
      State.viewDeckKey = dk;
      State.viewPos = 0;

      if(mode==="history"){
        el.historyName.textContent = `Ajalugu: ${dk}`;
        showScreen("history");
        renderViewCard();
        updateViewPos();
      } else {
        el.bestName.textContent = `Parimad: ${dk}`;
        showScreen("best");
        renderViewCard();
        updateViewPos();
      }
    }

    function updateProgress(){ el.progress.textContent = String(State.index + 1); }

    function renderStack(){
      el.deck.innerHTML = "";
      const top  = State.cards[State.index];
      const next = State.cards[State.index + 1];
      if(next) el.deck.appendChild(makeCard(next, true, "game"));
      if(top)  el.deck.appendChild(makeCard(top, false, "game"));
      if(!top){ showScreen("menu"); buildMenu(); }
      updateButtons();
    }

    function makeCard(card, isBehind, mode){
      const wrap = document.createElement("div");
      wrap.className = "swipeCard";
      wrap.style.transform = isBehind ? "scale(0.96) translateY(10px)" : "translate(0,0)";
      wrap.style.opacity = isBehind ? "0.93" : "1";

      const inner = document.createElement("div");
      inner.className = "inner";
      inner.innerHTML = `
        <div class="title">${card.title}</div>
        <div class="desc">${card.desc}</div>
        <div class="foot">${card.foot || ""}</div>
      `;

      wrap.appendChild(inner);

      if(mode === "game"){
        const starBtn = document.createElement("button");
        starBtn.className = "starBtn";
        starBtn.type = "button";
        starBtn.innerHTML = "<span>⭐</span>";
        starBtn.addEventListener("pointerdown", (e)=>{ e.stopPropagation(); e.preventDefault(); });
        starBtn.addEventListener("pointerup", (e)=>{
          e.stopPropagation(); e.preventDefault();
          const top = el.deck.querySelector(".swipeCard:last-child");
          if(top === wrap) markBestAndNext(wrap);
        });
        wrap.appendChild(starBtn);
      }

      if(!isBehind){
        if(mode==="game") attachSwipeGame(wrap);
        if(mode==="view") attachSwipeView(wrap);
      }
      return wrap;
    }

    function attachSwipeGame(cardEl){
      let sx=0, sy=0, dx=0, dy=0, dragging=false;

      cardEl.addEventListener("pointerdown", (e)=>{
        if(e.target && e.target.closest && e.target.closest(".starBtn")) return;
        dragging=true;
        cardEl.setPointerCapture(e.pointerId);
        sx=e.clientX; sy=e.clientY;
        cardEl.style.transition="none";
      });

      cardEl.addEventListener("pointermove", (e)=>{
        if(!dragging) return;
        dx=e.clientX-sx; dy=e.clientY-sy;
        const rot = clamp(dx/14, -18, 18);
        cardEl.style.transform = `translate(${dx}px, ${dy}px) rotate(${rot}deg)`;
      });

      cardEl.addEventListener("pointerup", ()=>{
        if(!dragging) return;
        dragging=false;
        cardEl.style.transition="transform 180ms ease, opacity 180ms ease";

        const tX=120, tY=130;
        if(dy < -tY && Math.abs(dx) < 140) markBestAndNext(cardEl);
        else if(dx > tX) nextCard(cardEl);
        else if(dx < -tX) prevCard();
        else cardEl.style.transform="translate(0,0) rotate(0deg)";
      });
    }

    function nextCard(cardEl){
      if(State.index >= State.cards.length - 1) { cardEl.style.transform="translate(0,0) rotate(0deg)"; return; }
      animateOut(cardEl, 520, -40, 18);
      pushHistory("EDASI");
      setTimeout(()=>{ State.index++; updateProgress(); renderStack(); buildMenu(); }, 170);
    }

    function markBestAndNext(cardEl){
      if(State.index >= State.cards.length) return;
      animateOut(cardEl, 0, -620, 0);
      pushHistory("PARIM", true);
      setTimeout(()=>{ State.index++; updateProgress(); renderStack(); buildMenu(); }, 170);
    }

    function prevCard(){
      if(State.index <= 0){ renderStack(); return; }
      undoHistoryForIndex(State.index - 1);
      State.index--;
      updateProgress();
      renderStack();
      buildMenu();
    }

    function animateOut(cardEl, tx, ty, rot){
      cardEl.style.transform = `translate(${tx}px, ${ty}px) rotate(${rot}deg)`;
      cardEl.style.opacity = "0";
    }

    function pushHistory(otsus, maybeBest){
      const dk = State.deckKey;
      const card = State.cards[State.index];
      if(!State.histories[dk]) State.histories[dk] = [];
      State.histories[dk].push({ idx: State.index, card, otsus });

      if(maybeBest){
        if(!State.bests[dk]) State.bests[dk] = [];
        const key = card.title + "||" + card.desc;
        const exists = State.bests[dk].some(x => (x.card.title + "||" + x.card.desc) === key);
        if(!exists) State.bests[dk].push({ card });
      }
    }

    function undoHistoryForIndex(idx){
      const dk = State.deckKey;
      const h = State.histories[dk] || [];
      const last = h[h.length - 1];
      if(!last || last.idx !== idx) return;

      h.pop();

      if(last.otsus === "PARIM"){
        const key = last.card.title + "||" + last.card.desc;
        State.bests[dk] = (State.bests[dk] || []).filter(x => (x.card.title + "||" + x.card.desc) !== key);
      }
    }

    function attachSwipeView(cardEl){
      let sx=0, dx=0, dragging=false;
      cardEl.addEventListener("pointerdown",(e)=>{
        dragging=true; cardEl.setPointerCapture(e.pointerId);
        sx=e.clientX; cardEl.style.transition="none";
      });
      cardEl.addEventListener("pointermove",(e)=>{
        if(!dragging) return;
        dx=e.clientX-sx;
        const rot = clamp(dx/18, -12, 12);
        cardEl.style.transform = `translate(${dx}px, 0px) rotate(${rot}deg)`;
      });
      cardEl.addEventListener("pointerup",()=>{
        if(!dragging) return;
        dragging=false; cardEl.style.transition="transform 180ms ease, opacity 180ms ease";
        const t=110;
        if(dx<-t) viewStep(-1);
        else if(dx>t) viewStep(+1);
        else cardEl.style.transform = "translate(0,0) rotate(0deg)";
      });
    }

    function renderViewCard(){
      const dk = State.viewDeckKey;
      const mode = State.viewMode;

      let list, host;
      if(mode==="history"){ list = State.histories[dk] || []; host = el.historyDeck; }
      else { list = State.bests[dk] || []; host = el.bestDeck; }

      host.innerHTML = "";
      const item = list[State.viewPos];

      if(!item){
        const empty = makeCard({title:"Pole midagi", desc:"Alusta mängu ja tee swiped.", foot:"• " + dk}, false, "view");
        host.appendChild(empty);
        updateButtons();
        return;
      }

      const c = makeCard(item.card, false, "view");
      host.appendChild(c);
      updateButtons();
    }

    function updateViewPos(){
      const dk = State.viewDeckKey;
      const mode = State.viewMode;
      const list = (mode==="history") ? (State.histories[dk] || []) : (State.bests[dk] || []);
      const pos = list.length ? (State.viewPos + 1) : 0;
      if(mode==="history") el.historyPos.textContent = String(pos);
      else el.bestPos.textContent = String(pos);
      updateButtons();
    }

    function viewStep(dir){
      const dk = State.viewDeckKey;
      const mode = State.viewMode;
      const list = (mode==="history") ? (State.histories[dk] || []) : (State.bests[dk] || []);
      if(!list.length) return;
      State.viewPos = clamp(State.viewPos + dir, 0, list.length - 1);
      renderViewCard();
      updateViewPos();
    }

    el.brandHome.addEventListener("click", ()=>{ showScreen("menu"); buildMenu(); });
    el.aboutBtn.addEventListener("click", ()=>{ showScreen("about"); });

    el.btnMenu.addEventListener("click", ()=>{ showScreen("menu"); buildMenu(); });

    el.btnNext.addEventListener("click", ()=>{
      if(State.viewMode==="game"){
        const top = el.deck.querySelector(".swipeCard:last-child");
        if(top) nextCard(top);
      } else if(State.viewMode==="history" || State.viewMode==="best"){
        viewStep(+1);
      } else if(State.viewMode==="about"){
        showScreen("menu"); buildMenu();
      }
    });

    el.btnBack.addEventListener("click", ()=>{
      if(State.viewMode==="game"){
        prevCard();
      } else if(State.viewMode==="history" || State.viewMode==="best"){
        viewStep(-1);
      } else if(State.viewMode==="about"){
        showScreen("menu"); buildMenu();
      }
    });

    function shuffle(arr){
      for(let i=arr.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]]=[arr[j],arr[i]];
      }
      return arr;
    }
    function clamp(v,min,max){ return Math.max(min, Math.min(max,v)); }

    buildMenu();
    showScreen("menu");
  </script>
</body>
</html>
