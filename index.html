<!doctype html>
<html lang="et">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Jutumasin</title>
  <style>
    :root{
      --bg1:#07000a; --bg2:#120014;
      --pink:#ff4da6; --pink2:#ff1f8f;
      --text:#ffe9f5; --muted:#d9a9c6;
      --card:#12000f; --card2:#1b0018;
      --r:22px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; height:100vh;
      display:flex; align-items:center; justify-content:center;
      padding:0;
      font-family:"Segoe UI Variable Display","Segoe UI Variable","Segoe UI",system-ui,-apple-system,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 15% 10%, rgba(255,77,166,.22), transparent 58%),
        radial-gradient(1100px 700px at 85% 20%, rgba(255,31,143,.18), transparent 62%),
        linear-gradient(180deg, var(--bg2), var(--bg1));
      overflow:hidden;
    }

    /* Taustasüdamed: background-position liigub üles (stabiilsem kui transform). */
    .bgHearts{
      position:fixed; inset:-45%;
      pointer-events:none;
      opacity:.11;
      filter: blur(.7px);
      background-repeat: repeat;
      background-image:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='980' height='980' viewBox='0 0 980 980'%3E%3Cg fill='%23ff4da6' fill-opacity='0.18'%3E%3Ctext x='110' y='560' font-size='320'%3E%E2%99%A5%3C/text%3E%3Ctext x='620' y='430' font-size='230'%3E%E2%99%A5%3C/text%3E%3Ctext x='470' y='910' font-size='270'%3E%E2%99%A5%3C/text%3E%3C/g%3E%3C/svg%3E");
      background-size: 980px 980px;
      will-change: background-position;
      animation: heartsUp 220s linear infinite;
    }
    .bgHearts2{
      position:fixed; inset:-55%;
      pointer-events:none;
      opacity:.07;
      filter: blur(1.05px);
      background-repeat: repeat;
      background-image:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='1380' height='1380' viewBox='0 0 1380 1380'%3E%3Cg fill='%23ff1f8f' fill-opacity='0.12'%3E%3Ctext x='140' y='790' font-size='520'%3E%E2%99%A5%3C/text%3E%3Ctext x='900' y='640' font-size='340'%3E%E2%99%A5%3C/text%3E%3Ctext x='680' y='1330' font-size='410'%3E%E2%99%A5%3C/text%3E%3C/g%3E%3C/svg%3E");
      background-size: 1380px 1380px;
      will-change: background-position;
      animation: heartsUp 330s linear infinite;
    }
    @keyframes heartsUp{
      from{ background-position: 0 0; }
      to{ background-position: 0 -2600px; }
    }

    .app{
      width:min(520px, 100%);
      height:100%;
      max-height:100vh;
      display:flex; flex-direction:column;
      background: linear-gradient(180deg, rgba(255,77,166,.12), rgba(0,0,0,.25));
      position:relative;
    }
    header{
      padding:14px 16px;
      display:flex; align-items:center; justify-content:center;
      border-bottom:1px solid rgba(255,77,166,.22);
      background: linear-gradient(90deg, rgba(255,77,166,.18), rgba(0,0,0,.18));
      min-height:64px;
    }
    .brand{
      font-weight:950;
      letter-spacing:.7px;
      text-transform: uppercase;
      background: linear-gradient(90deg, rgba(255,77,166,1), rgba(255,233,245,.95), rgba(255,31,143,1));
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
      text-shadow: 0 10px 40px rgba(255,77,166,.12);
      font-size:22px;
      transition: font-size 140ms ease, transform 140ms ease;
    }
    body[data-view="menu"] .brand{
      font-size:44px; /* topelt suurem pealehel */
      transform: translateY(1px);
    }

    main{flex:1; display:flex; flex-direction:column; min-height:0}
    .screen{flex:1; display:none; padding:16px; min-height:0}
    .screen.active{display:flex; flex-direction:column; gap:14px}

    .grid{display:grid; gap:12px; grid-template-columns:1fr 1fr}
    .choice{
      padding:16px; border-radius:var(--r);
      background: linear-gradient(180deg, rgba(255,77,166,.10), rgba(0,0,0,.26));
      border:1px solid rgba(255,77,166,.22);
      cursor:pointer;
      min-height:96px;
      display:flex; flex-direction:column; justify-content:center;
      transition: box-shadow 120ms ease, border-color 120ms ease, transform 120ms ease, background 120ms ease;
    }
    .choice:hover{
      border-color: rgba(255,233,245,.40);
      box-shadow: 0 0 0 2px rgba(255,233,245,.14), 0 14px 45px rgba(0,0,0,.35);
    }
    .choice:active{
      background: linear-gradient(180deg, rgba(255,77,166,.06), rgba(0,0,0,.36));
      transform: translateY(1px);
    }
    .choice h3{margin:0 0 8px 0; font-size:15px; font-weight:900}
    .choice p{margin:0; color:var(--muted); font-size:12px; line-height:1.25}

    .row{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .stat{
      padding:10px 12px; border-radius:16px;
      border:1px solid rgba(255,77,166,.22);
      background: rgba(0,0,0,.22);
      font-size:12px; color:var(--muted);
      white-space:nowrap;
    }

    .cardArea{flex:1; display:flex; align-items:center; justify-content:center; position:relative; padding:0; min-height:0}
    .deck{width:100%; height:100%; display:flex; align-items:center; justify-content:center; position:relative; min-height:0}
    .swipeCard{
      width:100%; max-width:520px; height:100%;
      border-radius:var(--r);
      background: linear-gradient(180deg, var(--card2), var(--card));
      border:1px solid rgba(255,77,166,.30);
      box-shadow: 0 18px 70px rgba(0,0,0,.65);
      position:absolute;
      touch-action:none;
      user-select:none;
      overflow:hidden;
      transform: translate(0,0) rotate(0deg);
      transition: transform 160ms ease, opacity 160ms ease;
    }
    .inner{
      height:100%;
      padding:26px 24px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      text-align:center;
      gap:18px;
      background:
        radial-gradient(1100px 700px at 20% 0%, rgba(255,77,166,.22), transparent 62%),
        radial-gradient(1100px 700px at 85% 20%, rgba(255,31,143,.18), transparent 62%);
    }
    .title{font-size:54px; font-weight:950; line-height:1.0}
    .desc{font-size:28px; font-weight:900; color:rgba(255,233,245,.95); line-height:1.2}
    .foot{
      position:absolute;
      left:24px; right:24px; bottom:18px;
      font-size:14px; font-weight:800;
      color:var(--muted);
      border-top:1px solid rgba(255,77,166,.22);
      padding-top:14px;
      text-align:left;
    }

    .stamp{
      position:absolute; top:16px; right:16px;
      font-weight:950; letter-spacing:.12em; font-size:16px;
      padding:10px 14px; border-radius:14px;
      border:2px solid rgba(255,255,255,.20);
      transform: rotate(8deg);
      opacity:0;
      pointer-events:none;
    }
    .stamp.edasi{color:var(--pink); border-color: rgba(255,77,166,.55); background: rgba(255,77,166,.12)}
    .stamp.tagasi{color:#ff6b8b; border-color: rgba(255,107,139,.55); background: rgba(255,107,139,.10)}
    .stamp.parim{color:#ffd1ea; border-color: rgba(255,209,234,.55); background: rgba(255,209,234,.12); transform: rotate(-6deg); left:16px; right:auto}

    /* Täheke on parim — peab dubleerima swipe-up tegevust. */
    .starBtn{
      position:absolute;
      right:14px;
      bottom:70px;
      width:46px; height:46px;
      border-radius:999px;
      display:flex; align-items:center; justify-content:center;
      border:1px solid rgba(255,209,234,.40);
      background: rgba(0,0,0,.28);
      box-shadow: 0 12px 30px rgba(0,0,0,.45);
      font-size:20px;
      line-height:1;
      padding:0;
      cursor:pointer;
      color:#ffd1ea;
      z-index:5;
    }
    .starBtn span{display:block; transform: translateY(-1px);}
    .starBtn:active{transform: translateY(1px)}

    .controls{
      padding:14px 16px;
      display:none;
      gap:12px; justify-content:center;
      border-top:1px solid rgba(255,77,166,.22);
      background: rgba(0,0,0,.22);
    }
    button.ctrl{
      appearance:none; border:none; cursor:pointer;
      border-radius:999px; padding:12px 16px;
      color:var(--text); font-weight:900;
      background: linear-gradient(180deg, rgba(255,77,166,.18), rgba(0,0,0,.25));
      border:1px solid rgba(255,77,166,.26);
      min-width:110px;
      transition: background 120ms ease;
    }
    button.ctrl:active{
      background: linear-gradient(180deg, rgba(255,77,166,.10), rgba(0,0,0,.38));
      transform: translateY(1px);
    }
    button.ctrl[disabled]{opacity:.45; cursor:default}
  </style>
</head>
<body data-view="menu">
  <div class="bgHearts"></div>
  <div class="bgHearts2"></div>

  <div class="app">
    <header><div class="brand">Jutumasin</div></header>

    <main>
      <section id="menuScreen" class="screen active">
        <div class="grid" id="menuGrid"></div>
      </section>

      <section id="gameScreen" class="screen">
        <div class="row">
          <div class="stat" id="deckName">Tüüp: —</div>
          <div class="stat" id="progress">0</div>
        </div>
        <div class="cardArea"><div class="deck" id="deck"></div></div>
      </section>

      <section id="historyScreen" class="screen">
        <div class="row">
          <div class="stat" id="historyName">Ajalugu: —</div>
          <div class="stat" id="historyPos">0</div>
        </div>
        <div class="cardArea"><div class="deck" id="historyDeck"></div></div>
      </section>

      <section id="bestScreen" class="screen">
        <div class="row">
          <div class="stat" id="bestName">Parimad: —</div>
          <div class="stat" id="bestPos">0</div>
        </div>
        <div class="cardArea"><div class="deck" id="bestDeck"></div></div>
      </section>
    </main>

    <div class="controls" id="controls">
      <button class="ctrl" id="btnBack">⬅️ Tagasi</button>
      <button class="ctrl" id="btnMenu">☰ Menüü</button>
      <button class="ctrl" id="btnNext">Edasi ➡️</button>
    </div>
  </div>

  <script>
    const DECKS = {
      "Dating": [
        { title:"Kohv ja jalutuskäik", desc:"Kiire vibe-check. Lihtne, aus, turvaline.", foot:"• kohtingu küsimused" },
        { title:"Muuseum", desc:"Räägi kunstist (või vähemalt raamidest).", foot:"• kohtingu küsimused" },
        { title:"Õhtune linnatiir", desc:"Tulede all on kõik natuke romantilisem.", foot:"• kohtingu küsimused" },
        { title:"Kokkame koos", desc:"Kui läheb pekki, tellime pitsat.", foot:"• kohtingu küsimused" }
      ],
      "Spicy": [
        { title:"Salajane koht", desc:"Üks vihje. Üks sihtkoht. Üks risk.", foot:"• põnevamad küsimused" },
        { title:"Julge mäng", desc:"Küsimused, mis lähevad natuke liiga ausaks.", foot:"• põnevamad küsimused" },
        { title:"Öine sõit", desc:"Muusika põhja ja mõtted välja.", foot:"• põnevamad küsimused" },
        { title:"Üks asi", desc:"Ütle üks asi, mida sa päriselt tahad.", foot:"• põnevamad küsimused" }
      ],
      "Couples": [
        { title:"Pühapäeva rituaal", desc:"Loome oma väikese traditsiooni.", foot:"• paaridele küsimused" },
        { title:"Unistuste reis", desc:"Valime sihi ja hakkame koguma.", foot:"• paaridele küsimused" },
        { title:"Digipaus", desc:"Telefonid kõrvale. Meie aeg.", foot:"• paaridele küsimused" },
        { title:"Tänulikkuse ring", desc:"Ütle 3 asja, mida sa hindad.", foot:"• paaridele küsimused" }
      ],
      "Party": [
        { title:"Kiirchallenge", desc:"10 minutit ja 3 naljakat ülesannet.", foot:"• peomänguks" },
        { title:"Karaoke duel", desc:"Halb laul on ka laul.", foot:"• peomänguks" },
        { title:"Mini-piknik", desc:"Poes 5€ limiit. Loovus võidab.", foot:"• peomänguks" },
        { title:"Mälumäng", desc:"Kes kaotab, teeb järgmise kohvi.", foot:"• peomänguks" }
      ]
    };

    const State = {
      deckKey: null,
      cards: [],
      index: 0,
      histories: {},
      bests: {},
      viewDeckKey: null,
      viewMode: "menu",
      viewPos: 0
    };

    const el = {
      menu: document.getElementById("menuScreen"),
      game: document.getElementById("gameScreen"),
      history: document.getElementById("historyScreen"),
      best: document.getElementById("bestScreen"),
      menuGrid: document.getElementById("menuGrid"),
      deck: document.getElementById("deck"),
      historyDeck: document.getElementById("historyDeck"),
      bestDeck: document.getElementById("bestDeck"),
      deckName: document.getElementById("deckName"),
      progress: document.getElementById("progress"),
      historyName: document.getElementById("historyName"),
      historyPos: document.getElementById("historyPos"),
      bestName: document.getElementById("bestName"),
      bestPos: document.getElementById("bestPos"),
      controls: document.getElementById("controls"),
      btnBack: document.getElementById("btnBack"),
      btnMenu: document.getElementById("btnMenu"),
      btnNext: document.getElementById("btnNext")
    };

    /* Näitab õige vaate, peidab/kuvab alumise riba ning lülitab “menu” logo suuruse. */
    function showScreen(name){
      el.menu.classList.toggle("active", name === "menu");
      el.game.classList.toggle("active", name === "game");
      el.history.classList.toggle("active", name === "history");
      el.best.classList.toggle("active", name === "best");
      State.viewMode = name;
      document.body.setAttribute("data-view", name);
      el.controls.style.display = (name === "menu") ? "none" : "flex";
      updateButtons();
    }

    /* Loendab ajalugu/parimad koguarvud menüü kirjelduste jaoks. */
    function totalCount(map){
      let n=0; Object.keys(map).forEach(k => n += (map[k]?.length || 0)); return n;
    }

    /* Ehitas menüü 6 valikuga (4 pakki + ajalugu + parimad) kirjelduste põhjal. */
    function buildMenu(){
      const hTotal = totalCount(State.histories);
      const bTotal = totalCount(State.bests);

      const items = [
        { title:"Dating",  sub:"kohtingu küsimused", action:()=>startGame("Dating") },
        { title:"Spicy",   sub:"põnevamad küsimused", action:()=>startGame("Spicy") },
        { title:"Couples", sub:"paaridele küsimused", action:()=>startGame("Couples") },
        { title:"Party",   sub:"peomänguks", action:()=>startGame("Party") },
        { title:"Ajalugu", sub:`mis sa enne swipinud oled (${hTotal})`, action:()=>openList("history") },
        { title:"Parimad", sub:`välja valitud parimad (${bTotal})`, action:()=>openList("best") }
      ];

      el.menuGrid.innerHTML = "";
      items.forEach(it=>{
        const c=document.createElement("div");
        c.className="choice";
        c.innerHTML = `<h3>${it.title}</h3><p>${it.sub}</p>`;
        c.addEventListener("click", it.action);
        el.menuGrid.appendChild(c);
      });
    }

    /* Seab nupud disabled olekusse Ajalugu/Parimad vaates (et ei saaks üle piiride minna). */
    function updateButtons(){
      if(State.viewMode === "history"){
        const list = State.histories[State.viewDeckKey] || [];
        el.btnBack.disabled = !(list.length && State.viewPos > 0);
        el.btnNext.disabled = !(list.length && State.viewPos < list.length - 1);
      } else if(State.viewMode === "best"){
        const list = State.bests[State.viewDeckKey] || [];
        el.btnBack.disabled = !(list.length && State.viewPos > 0);
        el.btnNext.disabled = !(list.length && State.viewPos < list.length - 1);
      } else {
        el.btnBack.disabled = false;
        el.btnNext.disabled = false;
      }
    }

    /* Käivitab mängu valitud pakiga ning segab kaardid uueks läbimiseks. */
    function startGame(deckKey){
      State.deckKey = deckKey;
      State.cards = shuffle([...DECKS[deckKey]]);
      State.index = 0;
      if(!State.histories[deckKey]) State.histories[deckKey] = [];
      if(!State.bests[deckKey]) State.bests[deckKey] = [];
      el.deckName.textContent = `Tüüp: ${deckKey}`;
      showScreen("game");
      renderStack();
      updateProgress();
      buildMenu();
    }

    /* Avab Ajalugu või Parimad (vaikimisi viimati mängitud pakk, muidu esimene). */
    function openList(mode){
      const dk = State.deckKey || Object.keys(DECKS)[0];
      State.viewDeckKey = dk;
      State.viewPos = 0;

      if(mode==="history"){
        el.historyName.textContent = `Ajalugu: ${dk}`;
        showScreen("history");
        renderViewCard();
        updateViewPos();
      } else {
        el.bestName.textContent = `Parimad: ${dk}`;
        showScreen("best");
        renderViewCard();
        updateViewPos();
      }
    }

    /* Näitab ainult “mitmes kaart on” (ilma koguarvuta). */
    function updateProgress(){
      el.progress.textContent = String(State.index + 1);
    }

    /* Renderdab kaks kaarti (järgmine + aktiivne) ja lõpetab otsa saamisel menüüga. */
    function renderStack(){
      el.deck.innerHTML = "";
      const next = State.cards[State.index + 1];
      const top  = State.cards[State.index];
      if(next) el.deck.appendChild(makeCard(next, true, "game"));
      if(top)  el.deck.appendChild(makeCard(top, false, "game"));
      if(!top){ showScreen("menu"); buildMenu(); }
    }

    /* Loob ühe kaardielemendi; “täheke” on klikitav ning peab dubleerima PARIM swipe tegevust. */
    function makeCard(card, isBehind, mode){
      const wrap = document.createElement("div");
      wrap.className = "swipeCard";
      wrap.style.transform = isBehind ? "scale(0.96) translateY(10px)" : "translate(0,0)";
      wrap.style.opacity = isBehind ? "0.93" : "1";

      const stampNext = document.createElement("div");
      stampNext.className = "stamp edasi";
      stampNext.textContent = "EDASI";

      const stampBack = document.createElement("div");
      stampBack.className = "stamp tagasi";
      stampBack.textContent = "TAGASI";

      const stampBest = document.createElement("div");
      stampBest.className = "stamp parim";
      stampBest.textContent = "PARIM";

      const inner = document.createElement("div");
      inner.className = "inner";
      inner.innerHTML = `
        <div class="title">${card.title}</div>
        <div class="desc">${card.desc}</div>
        <div class="foot">${card.foot || ""}</div>
      `;

      wrap.appendChild(stampNext);
      wrap.appendChild(stampBack);
      wrap.appendChild(stampBest);

      if(mode === "game"){
        const starBtn = document.createElement("button");
        starBtn.className = "starBtn";
        starBtn.type = "button";
        starBtn.innerHTML = "<span>⭐</span>";

        /* Blokeerib kaardi drag/pointercapture, et click oleks usaldusväärne. */
        starBtn.addEventListener("pointerdown", (e)=>{ e.stopPropagation(); e.preventDefault(); });

        /* Käivitab sama loogika mis swipe-up: PARIM + järgmine kaart. */
        starBtn.addEventListener("pointerup", (e)=>{
          e.stopPropagation(); e.preventDefault();
          const top = el.deck.querySelector(".swipeCard:last-child");
          if(top === wrap) commitSwipeGame(wrap, "PARIM");
        });

        wrap.appendChild(starBtn);
      }

      wrap.appendChild(inner);

      if(!isBehind){
        if(mode==="game") attachSwipeGame(wrap, stampNext, stampBack, stampBest);
        if(mode==="view") attachSwipeView(wrap);
      }
      return wrap;
    }

    /* Mängu swipe: vasak=TAGASI, parem=EDASI, üles=PARIM; ignoreerib tähekese klikke. */
    function attachSwipeGame(cardEl, nextStamp, backStamp, bestStamp){
      let sx=0, sy=0, dx=0, dy=0, dragging=false;

      cardEl.addEventListener("pointerdown", (e)=>{
        if(e.target && e.target.closest && e.target.closest(".starBtn")) return;
        dragging=true;
        cardEl.setPointerCapture(e.pointerId);
        sx=e.clientX; sy=e.clientY;
        cardEl.style.transition="none";
      });

      cardEl.addEventListener("pointermove", (e)=>{
        if(!dragging) return;
        dx=e.clientX-sx; dy=e.clientY-sy;

        const rot = clamp(dx/14, -18, 18);
        cardEl.style.transform = `translate(${dx}px, ${dy}px) rotate(${rot}deg)`;

        const aNext = clamp((dx-40)/120, 0, 1);
        const aBack = clamp((-dx-40)/120, 0, 1);
        const aBest = clamp((-dy-50)/140, 0, 1);

        nextStamp.style.opacity = aNext.toFixed(2);
        backStamp.style.opacity = aBack.toFixed(2);
        bestStamp.style.opacity = aBest.toFixed(2);
      });

      cardEl.addEventListener("pointerup", ()=>{
        if(!dragging) return;
        dragging=false;
        cardEl.style.transition="transform 180ms ease, opacity 180ms ease";

        const tX=120, tY=130;
        if(dy < -tY && Math.abs(dx) < 140) commitSwipeGame(cardEl, "PARIM");
        else if(dx > tX) commitSwipeGame(cardEl, "EDASI");
        else if(dx < -tX) commitSwipeGame(cardEl, "TAGASI");
        else{
          cardEl.style.transform="translate(0,0) rotate(0deg)";
          nextStamp.style.opacity=0; backStamp.style.opacity=0; bestStamp.style.opacity=0;
        }
      });
    }

    /* Rakendab swipe tulemuse: animatsioon + ajaloo/parimate salvestus + järgmise kaardi kuvamine. */
    function commitSwipeGame(cardEl, otsus){
      let tx=0, ty=0, rot=0;
      if(otsus==="EDASI"){ tx=520; ty=-40; rot=18; }
      if(otsus==="TAGASI"){ tx=-520; ty=-40; rot=-18; }
      if(otsus==="PARIM"){ tx=0; ty=-620; rot=0; }

      cardEl.style.transform = `translate(${tx}px, ${ty}px) rotate(${rot}deg)`;
      cardEl.style.opacity = "0";

      const dk = State.deckKey;
      const card = State.cards[State.index];

      State.histories[dk].push({ card, otsus });

      if(otsus==="PARIM"){
        const key = card.title + "||" + card.desc;
        const exists = State.bests[dk].some(x => (x.card.title + "||" + x.card.desc) === key);
        if(!exists) State.bests[dk].push({ card });
      }

      setTimeout(()=>{
        State.index++;
        updateProgress();
        renderStack();
        buildMenu();
      }, 170);
    }

    /* Vaate (Ajalugu/Parimad) swipe: vasak tagasi, parem edasi; ei muuda andmeid. */
    function attachSwipeView(cardEl){
      let sx=0, dx=0, dragging=false;

      cardEl.addEventListener("pointerdown",(e)=>{
        dragging=true;
        cardEl.setPointerCapture(e.pointerId);
        sx=e.clientX;
        cardEl.style.transition="none";
      });

      cardEl.addEventListener("pointermove",(e)=>{
        if(!dragging) return;
        dx=e.clientX-sx;
        const rot = clamp(dx/18, -12, 12);
        cardEl.style.transform = `translate(${dx}px, 0px) rotate(${rot}deg)`;
      });

      cardEl.addEventListener("pointerup",()=>{
        if(!dragging) return;
        dragging=false;
        cardEl.style.transition="transform 180ms ease, opacity 180ms ease";
        const t=110;
        if(dx<-t) viewStep(-1);
        else if(dx>t) viewStep(+1);
        else cardEl.style.transform = "translate(0,0) rotate(0deg)";
      });
    }

    /* Renderdab ühe kaardi Ajalugu/Parimad vaates (tühja korral ilma tähekese ja stampideta). */
    function renderViewCard(){
      const dk = State.viewDeckKey;
      const mode = State.viewMode;

      let list, host, isHistory;
      if(mode==="history"){ list = State.histories[dk] || []; host = el.historyDeck; isHistory = true; }
      else { list = State.bests[dk] || []; host = el.bestDeck; isHistory = false; }

      host.innerHTML = "";

      const item = list[State.viewPos];
      if(!item){
        const empty = makeCard({title:"Pole midagi", desc:"Alusta mängu ja tee swiped.", foot:"• " + dk}, false, "view");
        empty.querySelectorAll(".stamp").forEach(s => s.style.opacity = 0);
        host.appendChild(empty);
        updateButtons();
        return;
      }

      const c = makeCard(item.card, false, "view");
      c.querySelectorAll(".stamp").forEach(s => s.style.opacity = 0);

      if(isHistory){
        const sNext = c.querySelector(".stamp.edasi");
        const sBack = c.querySelector(".stamp.tagasi");
        const sBest = c.querySelector(".stamp.parim");
        sNext.style.opacity = item.otsus==="EDASI" ? 1 : 0;
        sBack.style.opacity = item.otsus==="TAGASI" ? 1 : 0;
        sBest.style.opacity = item.otsus==="PARIM" ? 1 : 0;
      } else {
        const sBest = c.querySelector(".stamp.parim");
        sBest.style.opacity = 1;
      }

      host.appendChild(c);
      updateButtons();
    }

    /* Uuendab Ajalugu/Parimad positsiooni näidu (ainult index). */
    function updateViewPos(){
      const dk = State.viewDeckKey;
      const mode = State.viewMode;
      const list = (mode==="history") ? (State.histories[dk] || []) : (State.bests[dk] || []);
      const pos = list.length ? (State.viewPos + 1) : 0;
      if(mode==="history") el.historyPos.textContent = String(pos);
      else el.bestPos.textContent = String(pos);
      updateButtons();
    }

    /* Liigutab Ajalugu/Parimad vaates positsiooni ja renderdab uuesti. */
    function viewStep(dir){
      const dk = State.viewDeckKey;
      const mode = State.viewMode;
      const list = (mode==="history") ? (State.histories[dk] || []) : (State.bests[dk] || []);
      if(!list.length) return;
      State.viewPos = clamp(State.viewPos + dir, 0, list.length - 1);
      renderViewCard();
      updateViewPos();
    }

    /* Menüü nupp viib alati tagasi pealehele. */
    el.btnMenu.addEventListener("click", ()=>{ showScreen("menu"); buildMenu(); });

    /* Edasi/Tagasi nupud peavad viima järgmise/eelmise kaardini (sama mis swipe parem/vasak). */
    el.btnNext.addEventListener("click", ()=>{
      if(State.viewMode==="game"){
        const top = el.deck.querySelector(".swipeCard:last-child");
        if(top) commitSwipeGame(top, "EDASI");
      } else if(State.viewMode==="history" || State.viewMode==="best"){
        viewStep(+1);
      }
    });

    el.btnBack.addEventListener("click", ()=>{
      if(State.viewMode==="game"){
        const top = el.deck.querySelector(".swipeCard:last-child");
        if(top) commitSwipeGame(top, "TAGASI");
      } else if(State.viewMode==="history" || State.viewMode==="best"){
        viewStep(-1);
      }
    });

    /* Segab kaardid, et iga mäng oleks erinev. */
    function shuffle(arr){
      for(let i=arr.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]]=[arr[j],arr[i]];
      }
      return arr;
    }

    /* Clamp hoiab väärtused piirides, et animatsioonid ja thresholdid oleksid stabiilsed. */
    function clamp(v,min,max){ return Math.max(min, Math.min(max,v)); }

    buildMenu();
    showScreen("menu");
  </script>
</body>
</html>
